\section{Wetter-API(Datenquelle)}
In diesem Kapitel wird auf die im Rahmen dieses Projektes Wetter-API vom Anbieter "OpenWeatherMap" und der anschließend eigens dafür implementierte Services zu dieser beschrieben. Anschließend werden die für den Services implementierten Klassen, Methoden und Tests beschrieben. Abschließend wird diese Komponente gegen die zu Beginn definierten Anforderungen validiert. 
\subsection{Die API}
Der Anbieter "OpenWeatherMap" bietet kostenlos die Möglichkeit Wetterdaten via Http-Request abzufragen. 
Hierzu ist lediglich ein Nutzerzugang erforderlich, welchen sich jeder anlegen kann. Es können verschiedene Vorhersagen abgefragt werden, für diese Arbeit beschränkt es sich jedoch auf die tägliche Vorhersage und eine  5-tages Vorhersage. Solch ein angesprochener Http-Request (hier für eine 5tägige Vorhersage) setzt sich wie folgt zusammen, 
\begin{lstlisting}
http://api.openweathermap.org/data/2.5/forecast?zip=78467,de&
APPID=41c464d95d33fabc24d44a5086ea9848
\end{lstlisting}

Der Parameter "ZIP" wird zum setzten der Postleitzahl für die gewünschte Stadt genutzt, zu diesem muss noch das Länderkürzel hinzugefügt werden. Die "APPID" wird von "OpenweatherMap" für jeden Nutzeraccount spezifisch vergeben und dient als Authentifizierung. Der Parameter"forecast" dient zur Unterscheidung zwischen einer aktuellen Vorhersage und einer 5-tages Vorhersage, bei Erster würde der Request wie folgt aussehen, 

\begin{lstlisting}
http://api.openweathermap.org/data/2.5/weather?zip=78467,de&
APPID=41c464d95d33fabc24d44a5086ea9848
\end{lstlisting}

hier muss lediglich der Parameter "forecast" durch "weather" ersetzt werden. 

"OpenWeatherMap" unterscheidet das Angebot zwischen kostenfrei und kostenpflichtig. Innerhalb der kostenpflichtigen Varianten gibt es Staffelungen, das gesamte Angebot wird aus Abb. \ref{img:OpenWeather} genauer ersichtlich. 

Für die in dieser Arbeit beschriebenen Lösung wurde auf die kostenfreie Variante gesetzt. Daher musste bei der Implementierung auf einige Einschränkungen geachtet werden, zu diesen gehören, 

\begin{itemize}
\item "Calls per minute (no more than)",
\item "Availibilty",
\item "Weather API data update".
\end{itemize}

Da auf das kostenfreie Modell gebaut wird, muss vor allem auf die erstgenannte Einschränkung (Abb. \ref{img:OpenWeather}) geachtet werden. Laut dieser sind lediglich 60 Requests mit den oben gezeigten URLs erlaubt. Im Rahmen der gesamten Anwendung wurde entscheiden, dass diese Applikation für alle Hauptstädte der 16 Bundesländer und Konstanz zur Verfügung stehen soll. Somit errechnet sich der Anteil an Requests pro Minute wie folgt,

\begin{align}
RequestsPerMin. = (16*2)+(2*2)\\
RequestsPerMin. = 36
\end{align}
somit kann ohne auf Probleme zu stoßen, ein Request-Intervall von 60 Sekunden, gewählt werden. 

\begin{figure}[!ht]
	\centering
	\includegraphics[width=1.0\textwidth]{Bilder/OpenWeatherMap.png}
	\caption{OpenWeatherMap Konditionen}
	\label{img:OpenWeather}
\end{figure} 
Im Bezug auf den "Response-Type" der API, kann entschieden werden, ob als "Response-Type" das Json- oder XML-Format gewählt werden soll. Aufgrund der guten Möglichkeiten von Java mit Json-Dokumente zu arbeiten, wurde  das Json-Format, als "Response-Type", gewählt.
Um bessere Vorstellungen von solch einem Response im Json-Format zu bekommen wird dieser untenstehend am Beispiel einer täglichen Vorhersage gezeigt.  

  \begin{lstlisting}
{"coord":{"lon":9.16,"lat":47.67},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"base":"stations","main":{"temp":297.6,"pressure":1021,"humidity":41,"temp_min":296.15,"temp_max":298.15},"visibility":10000,"wind":{"speed":5.7,"deg":30},"clouds":{"all":0},"dt":1497797400,"sys":{"type":1,"id":4915,"message":0.0038,"country":"DE","sunrise":1497756293,"sunset":1497813872},"id":0,"name":"Konstanz","cod":200}
\end{lstlisting}

Des weiteren wird am nächsten Beispiel der Response-Type für die 5-tägige Vorhersage aufgezeigt, jedoch wird hier aufgrund des hohen Umfangs nur ein kleiner Teil (für 3 Stunden) gezeigt. Im Normalfall besteht ein vollständiger Response aus im 3 stunden Takt 
folgenden Informationen für 5 Tage.
 
  \begin{lstlisting}
{"cod":"200","message":0.0035,"cnt":40,"list":[{"dt":1497808800,"main":{"temp":295.56,"temp_min":294.226,"temp_max":295.56,"pressure":957.98,"sea_level":1034.02,"grnd_level":957.98,"humidity":53,"temp_kf":1.34},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":2.46,"deg":51.5021},"sys":{"pod":"d"},"dt_txt":"2017-06-18 18:00:00"}
\end{lstlisting}
\clearpage
Um mit diesen Json-Response-Types besser und freier arbeiten zu können wurde ein Service implementiert, welche die Daten vorher Filtert, somit werden nur wichtige Informationen genutzt. Die Implementierung dieses Services wird im folgenden Abschnitt beschrieben. Der Service greift die Grundlagen und Problemstellungen der "OpenWeatherMap"-API auf, welche in diesem Abschnitt beschrieben wurden, von den Request-Intervallen bis hin zu den zwei verschiedenen Arten von Vorhersagen.

\subsection{Die Komponenten und Klassen}

***TODO: Komponenten Diagramm*****

kurzer Absatz zu den Komponenten und den Zusammenhang 

Die zugrundeliegenden Klassen in den einzelnen Komponenten werden im folgenden kurz beschrieben. Anschließend wird in den nächsten Abschnitten auf die wichtigsten Klassen und die darin enthaltenen Methoden noch genauer eingegangen. 

\begin{description}

\item[AuthenticationController:]
\item[MessagingController:]
\item[PermissionController:]
\item[User:]
\item[VHost:]
\item[WeatherData:]Die Klasse dient als Grundlage für die Datenstruktur der täglichen Daten des Json-Reponse, welche von der Klasse WeatherAPIService an die MoM gesendet werden. 
\item[WeatherDataWeekly:]Die Klasse dient als Grundlage für die Datenstruktur der wöchentlichen Daten des Json-Reponse, welche von der Klasse WeatherAPIService an die MoM gesendet werden. 
\item[UserRepository:]
\item[UserRepositoryImpl:]
\item[AuthenticationService:]
\item[AuthenticationServiceImpl:]
\item[MessagingService:]
\item[MomService:]
\item[SecurityService:]
\item[SecurtiyServiceImpl:]
\item[UserDetailsServiceImpl:]
\item[WeatherApiService:]Die Klasse regelt die HTTP-Requests an die "OpenWeatherAPI" und ließt die HTTP-Responses aus, diese Klasse wird im nächsten Abschnitt noch genauer eingeführt, da sie essentiell ist. 
\item[UserValidator:]
\item[VHostValidator:]
\item[WeatherFormValidator:]
\item[WeatherApiApplication:]
\item[WebSecurityConfig:]




\end{description}

\subsubsection{Wetter-API-Service}

Für den Zugriff und die Abfrage der "OpenWeatherMap“ -API wurde ein Service mit der Klasse "WeatherDataService" implementiert, welcher die Abfrage regelt und ein Json mit der gewünschten Struktur zurückliefert. Dieses Json wird dann mit Hilfe von "Mqtt" an die MoM (vlg. Kap.\ref{rabbitmq}) gepublished. 

Die gesamte Komponente verfügt über einen Web-Client. Dieser Web-Client stellt die Möglichkeit bereit Testdaten an die MoM zu senden oder aber die Abfrage der Wetterdaten an die "OpenWeatherMap"-API zu starten. Da für die gesamte Applikation die Livedaten von grundlegender Wichtigkeit sind, muss dieser Service zu jeder Zeit laufen. Es ist im Realbetrieb nicht vorgesehen, dass dieser gestoppt wird.

Nachfolgend werden die wichtigsten Methoden der Klasse "WeatherDataService" beschrieben. 

\begin{description}
\item["init()"] füllt eine HashMap mit allen gewünschten Postleitzahlen auf, nach welchen die "OpenWeatherMap"-API abgefragt werden soll.
\item["public void publishLiveWeatherData()"] ruft im Intervall von 60 Sekunden die Methoden "handlePLZtoday(plz, countryCode)“ und „handlePLZweekly(plz, countryCode)“ mit allen Postleitzahlen und Countrycodes auf, welche in der Init() -Methode eingelesen wurden. 
\item["public void handlePLZtoday(String plz, String countryCode)"] stellt einen HTTP-Request und fragt die tagesaktuellen Wetterdaten im Json-Format ab.
\item["public void dailyToWeatherData"] liest den von der Methode "handlePLZtoday" gestellten HTTP-Request aus und zieht die gewünschten Daten anhand der Struktur der Klasse "WeatherData" aus dem Response-Json der "OpenWeatherMap"-API. Anschließend wird  die gewünschte Json-Struktur zusammengebaut. 
\item["public void handlePLZweekly(String plz, String countryCode)"]stellt einen HTTP-Request und fragt die 5-tägigen Wetterdaten im Json-Format ab.
\item["public static ArrayList WeatherDataWeekly weeklyToWeatherDataWeekly
(JsonElement root, String plz)" ]liest den von der Methode "handlePLZweekly" gestellten HTTP-Request aus und zieht die gewünschten Daten anhand der Struktur der Klasse "WeatherDataWeekly" aus dem Response-Json der "OpenWeatherMap"-API. Anschließend wird die gewünschte Json-Struktur zusammengebaut.
\item["private void reconnectToMoM()"] stellt sicher, dass bei einem Verbindungsverlust zur MoM wieder eine Verbindung hergestellt wird. 
\item["public void publishFakeWeatherData(WeatherData weatherData)"] sendet die Daten, via Web-Client eingepflegt wurden, an die MoM. 
\end{description}

Im nachfolgenden Abschnitt wird noch auf zwei weitere Services eingegangen, den MoM-Service und den Authentifizierungsservice. 

\subsubsection{MoM-Service}

\subsubsection{Authentifizierungsservice}


\subsection{Testing}
Im Rahmen des Testings wurde für die Klasse "WeatherAPIService" eine Testklasse "WeatherAPIServiceTest" angelegt. 
Diese Klasse testet die wichtigsten Methoden der Ursprungsklasse, zu den Testmethoden gehören,

\begin{itemize}
\item "testAPICallTodayWithoutWindDeg()"
\item "testAPICallTodayWithWindDeg()"
\item "testAPICallWeeklyWithoutWindDeg()"
\item "testAPICallWeeklyWithWindDeg()"
\end{itemize}

Die ersten zwei Methoden Testen, für den Fall eines HTTP-Response seitens der API für eine tagesaktuelle Wettervorhersage. Dafür wurde ein String mit gefakten Daten angelegt, mit diesen Daten wurde dann die Methode "dailyToWeatherData" aufgerufen, somit kann sichergestellt werde, dass die endgültige Form des Json mit der gewünschte der "WeatherData" Klasse übereinstimmt. 
Hier muss jedoch eine Fallunterscheidung gemacht werden, da in der Methode noch mit Hilfe einer Kontrollstruktur der Fall angefangen wird, dass die API für die Windrichtung keinen Wert sendet. Dieser Fall tritt immer dann ein, wenn die Windstärke unter den Wert 1.5 sinkt. Aus diesem Grund gibt es, wie oben angegeben, diese zwei Fallunterscheidung bei den Testmethoden. 

Die weiteren zwei Methoden testen einen fast anlogen Fall zu den ersten zwei ab nur das hier ein HTTP-Response für eine 5-tägige Wettervorhersage getestet wird. Der unterschied besteht in der Konstruktion der Testdaten, da diese eine komplexere und größere Menge aufweisen, als in den ersten beiden Fällen. Aus dem Grund wurden 2 Hilfsmethoden implementiert, welche einen String bauen, welcher gleich einem API-Response für eine 5-tägige Vorhersage ist.

\subsection{12 Faktor App}\label{12FactorAppWeatherAPI}

\begin{table}[!ht]
  \centering
    \begin{minipage}{15cm}
      \centering
      \begin{tabular}{*{3}{|l|p{5.0cm}|p{5.0cm}}}\hline
      \multicolumn{4}{|c|}{\cellcolor[RGB]{200,200,200}Validierung nach "12 Faktor APP"} \\\hline
     \textbf{ID}&\textbf{Anforderung}&\textbf{Validierungs Element}&\textbf{Erfüllt}\\\hline
     1.&Codebase&Andere Komponenten sind nur für das Testszenario da. Deployment verschiedener Versionen über Repo möglich&Ja\\
      \hline
     2.&Abhängigkeiten&Zugriff auf die Datenbank und die "OpenWeatherMap"-API sind in eigenen Klassen isoliert&Ja\\
     \hline
     3.&Konfiguration&Credentials werden über Umgebungsvariablen im Jenkings-Server verwaltet&Ja\\
     \hline
     4.&Unterstützende Dienste&Credentials der "OpenWeatherMap"-API werden über die Umgebungsvariablen im Jenkins-Server verwaltet&Ja\\
     \hline 
     5.&Build, release, run&Wird über einen Jenkins-Server verwaltet&Ja\\
     \hline
     6.&Prozesse&Wird via Web-Gui gestartet&Ja\\
     \hline
      7.&Bindung an Ports&Die Ports werden von Pivotal verwaltet&Ja\\
     \hline
      8.&Nebenläufigkeit&Es könnte zu jeder Zeit eine neue Instanz auf Pivotal gestartet werden, jedoch bedarf es bei dieser Komponente keiner Skalierung&Ja\\
     \hline
      9.&Einweggebrauch&....&Nein\\
     \hline
     10.&Dev-Prod-Vergleichbarkeit&....&Nein\\
     \hline     
     11.&Logs&Pivotal gibt die Logs standardmäßig über Stdout aus&Ja\\
     \hline
     12.&Admin-Prozesse&....&Nein\\
     \hline
      \end{tabular}
   \caption{Validierung nach "12 Faktor APP"}\label{tab:Anforderungen}
    \end{minipage}
\end{table}

